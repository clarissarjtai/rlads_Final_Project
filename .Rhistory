warning()
knitr::opts_chunk$set(echo = TRUE)
library(htmlwidgets)
library(webshot)
library(dplyr)
library(zoo)
library(pracma)
library(ggplot2)
library(plotly)
library(dygraphs)
library(xts)
library(caret)
library(tidyr)
library(ggpmisc)
# 計算標準化數據與其七日簡單平均、七日指數平均、變動率
getMA_ROC <- function(df, prefix){
df$Date <- as.Date(df$Date)
df[prefix] <- as.numeric(unlist(df[prefix]))
preproc1 <- preProcess(df[prefix], method=c("center", "scale"))
df['norm'] <- predict(preproc1, df[prefix])
df['ROC'] <- (df['norm'] - lag(df['norm']))/lag(df['norm'])
df['7MA'] <- movavg(unlist(df['norm']),7, type="s")
df['7EMA'] <- movavg(unlist(df['norm']),7, type="e")
colnames(df) <- c("Date", prefix, paste0(prefix, c("_std","_ROC", "_7MA", "_7EMA")))
return(df)
}
# 計算台灣各類股繪圖資料
tw_cat_rmse <- function(df){
na = colnames(df[2])
df['real'] <- df[5]
df['pred'] <- df[3]
df['origin'] <- df[4]
df['residues'] = df['pred'] - df['real']
df['group'] = c(rep(seq(as.Date("2021-04-03"), as.Date("2021-05-28"), 5), each = 5), rep(as.Date("2021-06-02"),3)) # 補最後三個
df = df %>% group_by(group) %>%
summarise(rmse = sqrt(mean(sum(residues**2))), cases = sum(origin), sign = mean(sum(residues)), category = na)
return(df)
}
# read data
list.files('data\\stock')
# [1] "BTC-Oil-Gold-COVID.csv" "SP500.csv" "SP500_USnewcases.csv"   "TAIEX-COVID.csv"        "TAIEX.csv"              "TAIEX_7MA.csv"          "TAIEX_ROC.csv"
btc_oil_gold = read.csv("data\\stock\\BTC-Oil-Gold-COVID.csv", encoding = "UTF-8") # 比特幣-原油-黃金價格,七日簡單均線,變動率
US_SP500_ALL = read.csv("data\\stock\\SP500.csv", encoding = "UTF-8") # 美股標普五百指數原始數值
US_SP500_CAT = read.csv("data\\stock\\SP500_USnewcases.csv", encoding = "UTF-8") # 美股標普五百各類原始數值
TAIEX_COVID = read.csv("data\\stock\\TAIEX-COVID.csv", encoding = "UTF-8") # 台股大盤,七日簡單均線,變動率
TAIEX = read.csv("data\\stock\\TAIEX.csv", encoding = "UTF-8") # 台股類股原始數值
TAIEX_7MA = read.csv("data\\stock\\TAIEX_7MA.csv", encoding = "UTF-8") # 台股類股七日簡單均線
TAIEX_ROC = read.csv("data\\stock\\TAIEX_ROC.csv", encoding = "UTF-8") # 台股類股變動率
# 整合至資料列表
data_list = list(btc_oil_gold, US_SP500_ALL, US_SP500_CAT, TAIEX_COVID, TAIEX, TAIEX_7MA, TAIEX_ROC)
names(data_list) = gsub("-", "_",list.files('D:\\rlads_FinProj\\data\\stock'))
# get column names
col_names = lapply(data_list, colnames)
# rename data frame columns
col_names$TAIEX_ROC.csv = paste0(col_names$TAIEX_ROC.csv, "_ROC")
col_names$TAIEX_7MA.csv = paste0(col_names$TAIEX_7MA.csv, "_7MA")
col_names$TAIEX_COVID.csv = c("Date", "大盤", "大盤_ROC", "大盤_7MA", "大盤_7EMA", "TW_COVID", "TW_COVID_7MA", "TW_COVID_7EMA", "TW_COVID_CUM")
col_names$BTC_Oil_Gold_COVID.csv[1] = "Date"
# rename data frame columns
for (i in 1:length(data_list)){
names(data_list[[i]]) <- col_names[[i]]
}
knitr::opts_chunk$set(echo = TRUE)
library(htmlwidgets)
library(webshot)
library(dplyr)
library(zoo)
library(pracma)
library(ggplot2)
library(plotly)
library(dygraphs)
library(xts)
library(caret)
library(tidyr)
library(ggpmisc)
# 計算標準化數據與其七日簡單平均、七日指數平均、變動率
getMA_ROC <- function(df, prefix){
df$Date <- as.Date(df$Date)
df[prefix] <- as.numeric(unlist(df[prefix]))
preproc1 <- preProcess(df[prefix], method=c("center", "scale"))
df['norm'] <- predict(preproc1, df[prefix])
df['ROC'] <- (df['norm'] - lag(df['norm']))/lag(df['norm'])
df['7MA'] <- movavg(unlist(df['norm']),7, type="s")
df['7EMA'] <- movavg(unlist(df['norm']),7, type="e")
colnames(df) <- c("Date", prefix, paste0(prefix, c("_std","_ROC", "_7MA", "_7EMA")))
return(df)
}
# 計算台灣各類股繪圖資料
tw_cat_rmse <- function(df){
na = colnames(df[2])
df['real'] <- df[5]
df['pred'] <- df[3]
df['origin'] <- df[4]
df['residues'] = df['pred'] - df['real']
df['group'] = c(rep(seq(as.Date("2021-04-03"), as.Date("2021-05-28"), 5), each = 5), rep(as.Date("2021-06-02"),3)) # 補最後三個
df = df %>% group_by(group) %>%
summarise(rmse = sqrt(mean(sum(residues**2))), cases = sum(origin), sign = mean(sum(residues)), category = na)
return(df)
}
# read data
list.files('data\\stock')
# [1] "BTC-Oil-Gold-COVID.csv" "SP500.csv" "SP500_USnewcases.csv"   "TAIEX-COVID.csv"        "TAIEX.csv"              "TAIEX_7MA.csv"          "TAIEX_ROC.csv"
btc_oil_gold = read.csv("data\\stock\\BTC-Oil-Gold-COVID.csv", encoding = "UTF-8") # 比特幣-原油-黃金價格,七日簡單均線,變動率
US_SP500_ALL = read.csv("data\\stock\\SP500.csv", encoding = "UTF-8") # 美股標普五百指數原始數值
US_SP500_CAT = read.csv("data\\stock\\SP500_USnewcases.csv", encoding = "UTF-8") # 美股標普五百各類原始數值
TAIEX_COVID = read.csv("data\\stock\\TAIEX-COVID.csv", encoding = "UTF-8") # 台股大盤,七日簡單均線,變動率
TAIEX = read.csv("data\\stock\\TAIEX.csv", encoding = "UTF-8") # 台股類股原始數值
TAIEX_7MA = read.csv("data\\stock\\TAIEX_7MA.csv", encoding = "UTF-8") # 台股類股七日簡單均線
TAIEX_ROC = read.csv("data\\stock\\TAIEX_ROC.csv", encoding = "UTF-8") # 台股類股變動率
# 整合至資料列表
data_list = list(btc_oil_gold, US_SP500_ALL, US_SP500_CAT, TAIEX_COVID, TAIEX, TAIEX_7MA, TAIEX_ROC)
names(data_list) = gsub("-", "_",list.files('D:\\rlads_FinProj\\data\\stock'))
# get column names
col_names = lapply(data_list, colnames)
# rename data frame columns
col_names$TAIEX_ROC.csv = paste0(col_names$TAIEX_ROC.csv, "_ROC")
col_names$TAIEX_7MA.csv = paste0(col_names$TAIEX_7MA.csv, "_7MA")
col_names$TAIEX_COVID.csv = c("Date", "大盤", "大盤_ROC", "大盤_7MA", "大盤_7EMA", "TW_COVID", "TW_COVID_7MA", "TW_COVID_7EMA", "TW_COVID_CUM")
col_names$BTC_Oil_Gold_COVID.csv[1] = "Date"
# rename data frame columns
for (i in 1:length(data_list)){
names(data_list[[i]]) <- col_names[[i]]
}
TW_COVID = data_list$TAIEX_COVID.csv[c("Date", "TW_COVID", "TW_COVID_7MA", "TW_COVID_7EMA", "TW_COVID_CUM" )]
US_COVID = data_list$BTC_Oil_Gold_COVID.csv[c("Date","new_cases","new_cases_7MA", "total_cases")]
names(US_COVID) <- c("Date", "US_COVID", "US_COVID_7MA", "US_COVID_CUM")
TW_COVID = data_list$TAIEX_COVID.csv[c("Date", "TW_COVID", "TW_COVID_7MA", "TW_COVID_7EMA", "TW_COVID_CUM" )]
US_COVID = data_list$BTC_Oil_Gold_COVID.csv[c("Date","new_cases","new_cases_7MA", "total_cases")]
colnames(US_COVID) <- c("Date", "US_COVID", "US_COVID_7MA", "US_COVID_CUM")
US_COVID
data_list$BTC_Oil_Gold_COVID.csv
data_list
data_list$BTC_Oil_Gold_COVID.csv
col_names
colnames
# read data
list.files('data\\stock')
# [1] "BTC-Oil-Gold-COVID.csv" "SP500.csv" "SP500_USnewcases.csv"   "TAIEX-COVID.csv"        "TAIEX.csv"              "TAIEX_7MA.csv"          "TAIEX_ROC.csv"
btc_oil_gold = read.csv("data\\stock\\BTC-Oil-Gold-COVID.csv", encoding = "UTF-8") # 比特幣-原油-黃金價格,七日簡單均線,變動率
US_SP500_ALL = read.csv("data\\stock\\SP500.csv", encoding = "UTF-8") # 美股標普五百指數原始數值
US_SP500_CAT = read.csv("data\\stock\\SP500_USnewcases.csv", encoding = "UTF-8") # 美股標普五百各類原始數值
TAIEX_COVID = read.csv("data\\stock\\TAIEX-COVID.csv", encoding = "UTF-8") # 台股大盤,七日簡單均線,變動率
TAIEX = read.csv("data\\stock\\TAIEX.csv", encoding = "UTF-8") # 台股類股原始數值
TAIEX_7MA = read.csv("data\\stock\\TAIEX_7MA.csv", encoding = "UTF-8") # 台股類股七日簡單均線
TAIEX_ROC = read.csv("data\\stock\\TAIEX_ROC.csv", encoding = "UTF-8") # 台股類股變動率
# 整合至資料列表
data_list = list(btc_oil_gold, US_SP500_ALL, US_SP500_CAT, TAIEX_COVID, TAIEX, TAIEX_7MA, TAIEX_ROC)
names(data_list) = gsub("-", "_",list.files('D:\\rlads_FinProj\\data\\stock'))
# get column names
col_names = lapply(data_list, colnames)
# rename data frame columns
col_names$TAIEX_ROC.csv = paste0(col_names$TAIEX_ROC.csv, "_ROC")
col_names$TAIEX_7MA.csv = paste0(col_names$TAIEX_7MA.csv, "_7MA")
col_names$TAIEX_COVID.csv = c("Date", "大盤", "大盤_ROC", "大盤_7MA", "大盤_7EMA", "TW_COVID", "TW_COVID_7MA", "TW_COVID_7EMA", "TW_COVID_CUM")
col_names$BTC_Oil_Gold_COVID.csv[1] = "Date"
# rename data frame columns
for (i in 1:length(data_list)){
names(data_list[[i]]) <- col_names[[i]]
}
data_list
names(data_list[[i]])
data_list
names(data_list)
gsub("-", "_",list.files('D:\\rlads_FinProj\\data\\stock'))
knitr::opts_chunk$set(echo = TRUE)
library(htmlwidgets)
library(webshot)
library(dplyr)
library(zoo)
library(pracma)
library(ggplot2)
library(plotly)
library(dygraphs)
library(xts)
library(caret)
library(tidyr)
library(ggpmisc)
# 計算標準化數據與其七日簡單平均、七日指數平均、變動率
getMA_ROC <- function(df, prefix){
df$Date <- as.Date(df$Date)
df[prefix] <- as.numeric(unlist(df[prefix]))
preproc1 <- preProcess(df[prefix], method=c("center", "scale"))
df['norm'] <- predict(preproc1, df[prefix])
df['ROC'] <- (df['norm'] - lag(df['norm']))/lag(df['norm'])
df['7MA'] <- movavg(unlist(df['norm']),7, type="s")
df['7EMA'] <- movavg(unlist(df['norm']),7, type="e")
colnames(df) <- c("Date", prefix, paste0(prefix, c("_std","_ROC", "_7MA", "_7EMA")))
return(df)
}
# 計算台灣各類股繪圖資料
tw_cat_rmse <- function(df){
na = colnames(df[2])
df['real'] <- df[5]
df['pred'] <- df[3]
df['origin'] <- df[4]
df['residues'] = df['pred'] - df['real']
df['group'] = c(rep(seq(as.Date("2021-04-03"), as.Date("2021-05-28"), 5), each = 5), rep(as.Date("2021-06-02"),3)) # 補最後三個
df = df %>% group_by(group) %>%
summarise(rmse = sqrt(mean(sum(residues**2))), cases = sum(origin), sign = mean(sum(residues)), category = na)
return(df)
}
# read data
list.files('data\\stock')
# [1] "BTC-Oil-Gold-COVID.csv" "SP500.csv" "SP500_USnewcases.csv"   "TAIEX-COVID.csv"        "TAIEX.csv"              "TAIEX_7MA.csv"          "TAIEX_ROC.csv"
btc_oil_gold = read.csv("data\\stock\\BTC-Oil-Gold-COVID.csv", encoding = "UTF-8") # 比特幣-原油-黃金價格,七日簡單均線,變動率
US_SP500_ALL = read.csv("data\\stock\\SP500.csv", encoding = "UTF-8") # 美股標普五百指數原始數值
US_SP500_CAT = read.csv("data\\stock\\SP500_USnewcases.csv", encoding = "UTF-8") # 美股標普五百各類原始數值
TAIEX_COVID = read.csv("data\\stock\\TAIEX-COVID.csv", encoding = "UTF-8") # 台股大盤,七日簡單均線,變動率
TAIEX = read.csv("data\\stock\\TAIEX.csv", encoding = "UTF-8") # 台股類股原始數值
TAIEX_7MA = read.csv("data\\stock\\TAIEX_7MA.csv", encoding = "UTF-8") # 台股類股七日簡單均線
TAIEX_ROC = read.csv("data\\stock\\TAIEX_ROC.csv", encoding = "UTF-8") # 台股類股變動率
# 整合至資料列表
data_list = list(btc_oil_gold, US_SP500_ALL, US_SP500_CAT, TAIEX_COVID, TAIEX, TAIEX_7MA, TAIEX_ROC)
names(data_list) = gsub("-", "_",list.files('data\\stock'))
# get column names
col_names = lapply(data_list, colnames)
# rename data frame columns
col_names$TAIEX_ROC.csv = paste0(col_names$TAIEX_ROC.csv, "_ROC")
col_names$TAIEX_7MA.csv = paste0(col_names$TAIEX_7MA.csv, "_7MA")
col_names$TAIEX_COVID.csv = c("Date", "大盤", "大盤_ROC", "大盤_7MA", "大盤_7EMA", "TW_COVID", "TW_COVID_7MA", "TW_COVID_7EMA", "TW_COVID_CUM")
col_names$BTC_Oil_Gold_COVID.csv[1] = "Date"
# rename data frame columns
for (i in 1:length(data_list)){
names(data_list[[i]]) <- col_names[[i]]
}
TW_COVID = data_list$TAIEX_COVID.csv[c("Date", "TW_COVID", "TW_COVID_7MA", "TW_COVID_7EMA", "TW_COVID_CUM" )]
US_COVID = data_list$BTC_Oil_Gold_COVID.csv[c("Date","new_cases","new_cases_7MA", "total_cases")]
colnames(US_COVID) <- c("Date", "US_COVID", "US_COVID_7MA", "US_COVID_CUM")
BTC = data_list$BTC_Oil_Gold_COVID.csv[c("Date","BTC","BTC_7MA", "BTC_ROC")]
OIL = data_list$BTC_Oil_Gold_COVID.csv[c("Date","Oil","Oil_7MA", "Oil_ROC")]
GOLD = data_list$BTC_Oil_Gold_COVID.csv[c("Date","Gold","Gold_7MA", "Gold_ROC")]
TAIEX_ALL = data_list$TAIEX_COVID.csv[c("Date", "大盤", "大盤_ROC", "大盤_7MA", "大盤_7EMA" )]
TAIEX_CAT = list(data_list$TAIEX.csv[,2:34], data_list$TAIEX_7MA.csv[,2:34], data_list$TAIEX_ROC.csv[,2:34]) # 只保留類股數據與日期
US_SP500_CAT[c("X", "NewCases")] <- NULL # 要另外計算7MA, ROC
# US_SP500_ALL, US_SP500_CAT要另外計算7MA, ROC
# 整理後新的data_list
data_list = list(TW_COVID, US_COVID, BTC, OIL, GOLD, TAIEX_ALL, US_SP500_ALL)
setwd(".\\data\\plot\\stock") # 圖片輸出位置
temp_data = full_join(data_list[[7]], data_list[[2]], by = "Date")[c("Date","SP500_std","SP500_7MA", "SP500_7EMA","SP500_ROC","US_COVID_std")]
TW_COVID = data_list$TAIEX_COVID.csv[c("Date", "TW_COVID", "TW_COVID_7MA", "TW_COVID_7EMA", "TW_COVID_CUM" )]
US_COVID = data_list$BTC_Oil_Gold_COVID.csv[c("Date","new_cases","new_cases_7MA", "total_cases")]
colnames(US_COVID) <- c("Date", "US_COVID", "US_COVID_7MA", "US_COVID_CUM")
col <- c("TW_COVID", "US_COVID", "BTC", "Oil", "Gold", "大盤", "SP500")
for (i in 1:length(data_list)){
pref <- col[i]
dat <- data_list[[i]]
data_list[[i]] <- getMA_ROC(dat[c("Date",pref)], prefix = pref)
}
data_list
# 台灣類股
TAIEX_CAT_list = list()
for (i in 2:length(TAIEX_CAT[[1]])){
dat <- TAIEX_CAT[[1]][c(1,i)]
pref <- colnames(dat)[2]
TAIEX_CAT_list[[i-1]] <- getMA_ROC(dat[c("Date",pref)], prefix = pref)
}
head(TAIEX_CAT_list[[1]])
# 美國類股
US_SP500_CAT_list = list()
for (i in 2:length(US_SP500_CAT)){
dat <- US_SP500_CAT[c(1,i)]
pref <- colnames(dat)[2]
US_SP500_CAT_list[[i-1]] <- getMA_ROC(dat[c("Date",pref)], prefix = pref)
}
head(US_SP500_CAT_list[[1]])
temp_data = full_join(data_list[[7]], data_list[[2]], by = "Date")[c("Date","SP500_std","SP500_7MA", "SP500_7EMA","SP500_ROC","US_COVID_std")]
p <- temp_data %>%
ggplot( aes(US_COVID_std, SP500_7MA,  color=Date)) +
geom_point() +
geom_smooth(method = "lm") +
labs(title = "美國SP500指數-COVID-19確診人數散佈圖/趨勢圖",x='單日確診人數(標準化)',y='標準化後指數之七日簡單移動平均') +
theme_bw()
ggplotly(p)
saveWidget(ggplotly(p), file="\\plot\\stock\\SP500_7MA對US_COVID_std.html")
saveWidget(ggplotly(p), file="plot\\stock\\SP500_7MA對US_COVID_std.html")
